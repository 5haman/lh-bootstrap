#!/command/execlineb -S0

# This initramfs is a stub. It just performs coldplug.
# Since our rootfs shouldn't require a coldplug to be found,
# we could do away with the initramfs, but we leave it as an example.

/command/export PATH /command:/bin
/command/cd /
if { s6-echo "\n  initramfs (minimal)\n" }

if { s6-mount -wt sysfs sys /sys }
if { s6-mount -wt proc proc /proc }
if { s6-mount -wt devtmpfs dev /dev }


piperw 4 5
background
{
  fdclose 4
  mdevd -D 5
}
importas -u MDEVDPID !
fdclose 5
if -n { fdmove 0 4 forstdin -x 1 -- i exit 1 }  # readiness notif.
fdclose 4
if { mdevd-coldplug }
if { kill $MDEVDPID }

if { s6-mount -rt ext4 /dev/%%PARTITION%%1 /rootfs }

if { s6-mount -o move /sys /rootfs/sys }
if { s6-mount -o move /proc /rootfs/proc }
if { s6-mount -o move /dev /rootfs/dev }

cd /rootfs
./command/s6-envdir -I /etc/env
./command/if
{
  ./command/pipeline { ./command/s6-ls -a -x rootfs / }
  ./command/forstdin -p -d"\n" i
  ./command/importas -u i i
  ./command/s6-rmrf /${i}
}
./command/if { ./command/s6-mount -o move . / }
./command/s6-chroot .

./command/tryexec { /sbin/init $@ }
./command/tryexec { /bin/init $@ }
/etc/init $@
